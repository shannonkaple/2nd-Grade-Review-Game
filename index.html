<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tech Skills Battle • Drag & Drop</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    html, body { height: 100%; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .tile { user-select: none; }
    .dropzone.over { outline: 2px dashed #4f46e5; }
    .hidden-scrollbar::-webkit-scrollbar { display: none; }
    .hidden-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    button[disabled] { opacity: .6; cursor: not-allowed; }
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
  <div class="max-w-5xl mx-auto p-4 sm:p-6">
    <header class="flex items-center justify-between gap-4">
      <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">Tech Skills Battle</h1>
      <div class="text-xs sm:text-sm text-slate-500">Host on GitHub Pages • Realtime by Firebase</div>
    </header>

    <!-- Diagnostics (visible on page) -->
    <section id="diagnostics" class="mt-3 p-3 rounded-xl bg-indigo-50 text-indigo-900 text-sm border border-indigo-200">
      <div class="flex items-center justify-between gap-2">
        <div>
          <span class="font-semibold">Status:</span>
          <span id="diagText">Checking…</span>
        </div>
        <div class="flex gap-2">
          <button id="diagWrite" class="rounded-lg bg-indigo-600 text-white px-3 py-1.5">Test Write</button>
          <button id="diagRoom" class="rounded-lg bg-emerald-600 text-white px-3 py-1.5">Make Sample Room</button>
          <button id="diagClear" class="rounded-lg border border-indigo-300 px-3 py-1.5">Clear</button>
        </div>
      </div>
      <pre id="diagLog" class="mt-2 whitespace-pre-wrap"></pre>
      <div id="offlineBanner" class="hidden mt-2 p-2 rounded-lg bg-rose-100 text-rose-900 border border-rose-300">
        Running in <b>offline mode</b> (no realtime). To enable realtime battles, ask IT to allow:
        <code class="block mt-1">*.gstatic.com · *.firebaseio.com · *.googleapis.com · firebaseinstallations.googleapis.com</code>
      </div>
    </section>

    <!-- Auth / Join -->
    <section id="join" class="mt-6 grid gap-4 sm:grid-cols-2">
      <div class="p-4 sm:p-6 bg-white rounded-2xl shadow border border-slate-200">
        <h2 class="font-bold text-lg mb-2">1) Your Info</h2>
        <label class="block text-sm font-medium">Display name</label>
        <input id="nameInput" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., Jayden" />

        <label class="block text-sm font-medium mt-4">Class</label>
        <select id="classSelect" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
          <option value="">Select your class</option>
          <option>Class 1</option>
          <option>Class 2</option>
          <option>Class 3</option>
          <option>Class 4</option>
          <option>Class 5</option>
          <option>Class 6</option>
          <option>Class 7</option>
          <option>Class 8</option>
          <option>Class 9</option>
          <option>Class 10</option>
          <option>Class 11</option>
          <option>Class 12</option>
          <option>Class 13</option>
          <option>Class 14</option>
          <option>Class 15</option>
        </select>

        <div class="mt-4 grid grid-cols-2 gap-2">
          <button id="joinBtn" class="rounded-2xl bg-indigo-600 hover:bg-indigo-700 text-white py-2.5 font-semibold">Join Room</button>
          <button id="makeBtn" class="rounded-2xl bg-slate-900 hover:bg-black text-white py-2.5 font-semibold">Create Room</button>
        </div>
        <p class="mt-3 text-sm text-slate-500">Rooms are per-class. Share the <span class="font-semibold">Room Code</span> below with your classmates.</p>
      </div>

      <div class="p-4 sm:p-6 bg-white rounded-2xl shadow border border-slate-200">
        <h2 class="font-bold text-lg mb-2">2) Room</h2>
        <div class="flex items-end gap-2">
          <div class="flex-1">
            <label class="block text-sm font-medium">Room Code</label>
            <input id="roomInput" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., C1-7G4K" />
          </div>
          <button id="copyCodeBtn" class="rounded-xl px-3 py-2 border border-slate-300 text-slate-700">Copy</button>
        </div>

        <div class="mt-4 text-sm text-slate-600">
          <div>Players in room:</div>
          <div id="players" class="mt-2 grid grid-cols-2 sm:grid-cols-3 gap-2 max-h-36 overflow-auto hidden-scrollbar"></div>
        </div>

        <div class="mt-4 p-3 bg-indigo-50 rounded-xl text-sm text-indigo-900" id="roomTip">Create or enter a room to see the lobby.</div>
      </div>
    </section>

    <!-- Teacher Controls -->
    <section id="teacher" class="mt-6 p-4 sm:p-6 bg-white rounded-2xl shadow border border-slate-200 hidden">
      <div class="flex items-center justify-between">
        <h2 class="font-bold text-lg">Teacher Controls</h2>
        <div class="flex items-center gap-2">
          <input id="teacherPass" type="password" placeholder="Teacher password" class="rounded-xl border border-slate-300 px-3 py-2" />
          <button id="unlockBtn" class="rounded-xl bg-slate-900 text-white px-3 py-2 font-semibold">Unlock</button>
        </div>
      </div>

      <div id="teacherPanel" class="mt-4 grid sm:grid-cols-3 gap-4 hidden">
        <div>
          <label class="block text-sm font-medium">Select Challenge</label>
          <select id="challengeSelect" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2">
            <option value="homeRow">Home Row Builder (drag to correct order)</option>
            <option value="lettersAZ">A–Z Keyboard Order (top row)</option>
            <option value="postureQuiz">Posture Quick Check (true/false)</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium">Round Length</label>
          <select id="roundLength" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2">
            <option value="90">90s</option>
            <option value="60">60s</option>
            <option value="45">45s</option>
            <option value="30">30s</option>
          </select>
        </div>
        <div class="flex items-end">
          <button id="startBtn" class="w-full rounded-2xl bg-green-600 hover:bg-green-700 text-white py-2.5 font-bold">Start Round</button>
        </div>
      </div>
      <div id="roundInfo" class="mt-3 text-sm text-slate-600">Locked. Enter teacher password to start a round.</div>
    </section>

    <!-- Game Area -->
    <section id="game" class="mt-6 p-4 sm:p-6 bg-white rounded-2xl shadow border border-slate-200 hidden">
      <div class="flex items-center justify-between">
        <h2 class="font-bold text-lg" id="challengeTitle">Challenge</h2>
        <div class="text-sm">
          Time: <span id="timer" class="font-bold">00:00</span>
        </div>
      </div>
      <div id="challengeArea" class="mt-4"></div>
      <div class="mt-4 flex items-center gap-2">
        <button id="submitBtn" class="rounded-2xl bg-indigo-600 hover:bg-indigo-700 text-white py-2.5 px-4 font-semibold">Submit</button>
        <span id="feedback" class="text-sm"></span>
      </div>
    </section>

    <!-- Leaderboard -->
    <section id="board" class="mt-6 p-4 sm:p-6 bg-white rounded-2xl shadow border border-slate-200 hidden">
      <div class="flex items-center justify-between">
        <h2 class="font-bold text-lg">Leaderboard</h2>
        <button id="refreshBoard" class="rounded-xl border border-slate-300 px-3 py-1.5">Refresh</button>
      </div>
      <div id="boardTable" class="mt-3"></div>
    </section>

    <footer class="mt-8 text-center text-xs text-slate-500">Tip: Students should use two hands for click–drag–drop. Accuracy first, then speed! ✨</footer>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

  <script>
    // ===== Diagnostics helpers =====
    function logStatus(msg){
      const t = document.getElementById('diagText'); if(t) t.textContent = msg;
      const p = document.getElementById('diagLog'); if(p) p.textContent += (p.textContent?'\n':'') + msg;
    }
    window.addEventListener('error', e=> logStatus('PAGE ERROR: ' + (e?.message || (e.filename+':'+e.lineno))));

    // ===== Firebase config (your real keys) =====
    const firebaseConfig = {
      apiKey: "AIzaSyDiqYEzZSgkHQKngLnGz-aBPMx9R4Qva2g",
      authDomain: "review-game-6d670.firebaseapp.com",
      projectId: "review-game-6d670",
      storageBucket: "review-game-6d670.firebasestorage.app",
      messagingSenderId: "296308464379",
      appId: "1:296308464379:web:5b74f5b5e31a61b3eeae5e",
      measurementId: "G-Q9PSF3KVQ3"
    };

    // ===== Initialize Firebase with guard =====
    let db = null; let OFFLINE = false;
    (function init(){
      try{
        if(!window.firebase){
          OFFLINE = true; logStatus('SDK not available — offline mode');
          document.getElementById('offlineBanner').classList.remove('hidden');
          disableOnlineButtons();
          return;
        }
        const app = firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        logStatus('Init OK for project: ' + (firebaseConfig.projectId || 'unknown'));
        // probe write
        db.collection('diag').add({ when:new Date().toISOString(), who:'probe' })
          .then(()=>logStatus('WRITE OK: able to write to Firestore'))
          .catch(e=>{ logStatus('WRITE ERROR: ' + (e?.message || e)); });
      } catch(e){ logStatus('INIT ERROR: ' + (e?.message || e)); }
    })();

    function disableOnlineButtons(){
      document.getElementById('joinBtn').setAttribute('disabled','');
      document.getElementById('makeBtn').setAttribute('disabled','');
      document.getElementById('unlockBtn').setAttribute('disabled','');
      document.getElementById('startBtn').setAttribute('disabled','');
      document.getElementById('submitBtn').setAttribute('disabled','');
    }

    // ===== Utilities =====
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    function safeUUID(){ try{ if(crypto?.randomUUID) return crypto.randomUUID(); }catch(e){} return 'uid-'+Math.random().toString(16).slice(2)+Date.now(); }
    const state = { uid: safeUUID(), name:'', className:'', roomCode:'', teacherUnlocked:false, round:null, timerInterval:null, startTs:0, submitted:false };
    function genRoomCode(cls){ const letters = 'ABCDEFGHJKLMNPQRSTUVWXYZ'; const code = Array.from({length:4},()=>letters[Math.floor(Math.random()*letters.length)]).join(''); const short=(cls||'C').replace(/[^0-9A-Za-z]/g,'').slice(0,3)||'C'; return `${short.toUpperCase()}-${code}`; }
    function formatMs(ms){ const s=Math.max(0,Math.floor(ms/1000)); const m=Math.floor(s/60).toString().padStart(2,'0'); const r=(s%60).toString().padStart(2,'0'); return `${m}:${r}`; }
    function toast(msg, ok=true){ const el=document.createElement('div'); el.className=`fixed left-1/2 -translate-x-1/2 top-4 z-50 px-4 py-2 rounded-xl shadow-lg ${ok?'bg-green-600 text-white':'bg-rose-600 text-white'}`; el.textContent=msg; document.body.appendChild(el); setTimeout(()=>el.remove(),2000); }

    // ===== Lobby & Room =====
    let playersUnsub=null;
    async function createRoom(){
      if(OFFLINE){ toast('Offline: network is blocking Firebase', false); return; }
      const name=$('#nameInput').value.trim(); const className=$('#classSelect').value.trim(); if(!name||!className){ toast('Enter name and class', false); return; }
      const code=genRoomCode(className); $('#roomInput').value=code;
      try{
        await db.collection('rooms').doc(code).set({ className, createdAt: firebase.firestore.FieldValue.serverTimestamp(), status:'lobby', currentChallenge:null, endsAt:null }, { merge:true });
        joinRoom(code,name,className);
      }catch(e){ toast('Create failed: '+(e?.message||e), false); }
    }
    async function joinExisting(){
      if(OFFLINE){ toast('Offline: network is blocking Firebase', false); return; }
      const name=$('#nameInput').value.trim(); const className=$('#classSelect').value.trim(); const code=$('#roomInput').value.trim(); if(!name||!className||!code){ toast('Fill name, class, and room', false); return; }
      try{
        const doc=await db.collection('rooms').doc(code).get(); if(!doc.exists){ toast('Room not found', false); return; }
        joinRoom(code,name,className);
      }catch(e){ toast('Join failed: '+(e?.message||e), false); }
    }
    async function joinRoom(code,name,className){
      state.name=name; state.className=className; state.roomCode=code; $('#roomTip').textContent=`Room ${code} • Waiting in lobby...`; $('#teacher').classList.remove('hidden');
      await db.collection('rooms').doc(code).collection('players').doc(state.uid).set({ name, className, joinedAt: firebase.firestore.FieldValue.serverTimestamp(), ready:true, score:0, timeMs:0, submittedAt:null }, { merge:true });
      if(playersUnsub) playersUnsub();
      playersUnsub = db.collection('rooms').doc(code).collection('players').orderBy('joinedAt','asc').onSnapshot(snap=>{
        const wrap=$('#players'); wrap.innerHTML=''; wrap.parentElement.querySelector('div').classList.remove('hidden'); wrap.classList.remove('hidden');
        snap.forEach(doc=>{ const p=doc.data(); const chip=document.createElement('div'); chip.className='px-3 py-1.5 rounded-xl bg-slate-100 border border-slate-200 text-sm'; chip.textContent=p.name||'Player'; wrap.appendChild(chip); });
      });
      db.collection('rooms').doc(code).onSnapshot(doc=>{ const r=doc.data(); if(!r) return; if(r.status==='running'&&r.currentChallenge){ state.round={challengeId:r.currentChallenge, endsAt:r.endsAt?.toDate?.()||null}; startChallenge(r.currentChallenge, r.endsAt?.toDate?.()); } if(r.status==='lobby'){ $('#game').classList.add('hidden'); $('#board').classList.add('hidden'); $('#roundInfo').textContent='In lobby. Start a round when ready.'; } });
    }

    // ===== Teacher controls =====
    $('#unlockBtn').addEventListener('click', ()=>{ const pass=$('#teacherPass').value; if(pass==='rigby'){ state.teacherUnlocked=true; $('#teacherPanel').classList.remove('hidden'); $('#roundInfo').textContent='Ready to start a round.'; toast('Teacher unlocked'); } else { toast('Wrong password', false); } });
    $('#startBtn').addEventListener('click', async ()=>{ if(!state.teacherUnlocked) return toast('Unlock teacher controls', false); if(!state.roomCode) return toast('Join or create a room first', false); const challengeId=$('#challengeSelect').value; const len=parseInt($('#roundLength').value,10)||60; const endsAt=new Date(Date.now()+len*1000); try{ await db.collection('rooms').doc(state.roomCode).set({ status:'running', currentChallenge:challengeId, endsAt }, { merge:true }); const playersRef=db.collection('rooms').doc(state.roomCode).collection('players'); const players=await playersRef.get(); const batch=db.batch(); players.forEach(doc=>{ batch.set(playersRef.doc(doc.id), { score:0, timeMs:0, submittedAt:null }, { merge:true }); }); await batch.commit(); toast('Round started!'); }catch(e){ toast('Start failed: '+(e?.message||e), false); }});

    // ===== Challenges =====
    function startTimer(endsAt){ clearInterval(state.timerInterval); const endMs=endsAt?endsAt.getTime():(Date.now()+60000); state.startTs=Date.now(); state.timerInterval=setInterval(()=>{ const remain=Math.max(0,endMs-Date.now()); $('#timer').textContent=formatMs(remain); if(remain<=0){ clearInterval(state.timerInterval); submitScore(true); } },200); }
    function startChallenge(challengeId, endsAt){ state.submitted=false; $('#game').classList.remove('hidden'); $('#board').classList.add('hidden'); $('#feedback').textContent=''; const area=$('#challengeArea'); area.innerHTML=''; let title=''; if(challengeId==='homeRow'){ title='Home Row Builder (F J anchors)'; const answer=['A','S','D','F','J','K','L',';']; renderDragSort(area, answer, { hint:'Drag tiles into the correct home-row order, left → right.' }); $('#submitBtn').onclick=()=>gradeDragSort(answer);} else if(challengeId==='lettersAZ'){ title='Top Row A–Z (Q → P)'; const answer=['Q','W','E','R','T','Y','U','I','O','P']; renderDragSort(area, answer, { hint:'Arrange the top row letters like on a real keyboard.' }); $('#submitBtn').onclick=()=>gradeDragSort(answer);} else if(challengeId==='postureQuiz'){ title='Posture Quick Check'; renderPostureQuiz(area); $('#submitBtn').onclick=gradePostureQuiz;} $('#challengeTitle').textContent=title; startTimer(endsAt); }
    function renderDragSort(container, answer, opts={}){ const shuffled=[...answer].sort(()=>Math.random()-0.5); const instr=document.createElement('p'); instr.className='text-sm text-slate-600'; instr.textContent=opts.hint||''; container.appendChild(instr); const bank=document.createElement('div'); bank.id='bank'; bank.className='mt-3 flex flex-wrap gap-2 p-3 bg-slate-50 rounded-xl border border-slate-200'; shuffled.forEach(ch=>bank.appendChild(makeTile(ch))); const row=document.createElement('div'); row.id='row'; row.className='mt-4 grid grid-cols-8 sm:grid-cols-8 gap-2'; for(let i=0;i<answer.length;i++) row.appendChild(makeDropSlot()); container.appendChild(bank); container.appendChild(row); enableDnD(); }
    function makeTile(text){ const el=document.createElement('div'); el.className='tile cursor-move select-none px-4 py-3 rounded-2xl bg-white border border-slate-300 shadow-sm font-bold text-lg text-center'; el.draggable=true; el.textContent=text; return el; }
    function makeDropSlot(){ const el=document.createElement('div'); el.className='dropzone h-12 rounded-2xl bg-slate-100 border border-slate-200 flex items-center justify-center text-slate-400'; el.dataset.slot='1'; return el; }
    function enableDnD(){ document.addEventListener('dragstart', e=>{ if(e.target.classList.contains('tile')){ e.dataTransfer.setData('text/plain', e.target.textContent); e.dataTransfer.effectAllowed='move'; e.target.classList.add('ring','ring-indigo-500'); }}); document.addEventListener('dragend', e=>{ if(e.target.classList.contains('tile')){ e.target.classList.remove('ring','ring-indigo-500'); }}); $$('#challengeArea .dropzone').forEach(zone=>{ zone.addEventListener('dragover', e=>{ e.preventDefault(); zone.classList.add('over'); }); zone.addEventListener('dragleave', ()=> zone.classList.remove('over')); zone.addEventListener('drop', e=>{ e.preventDefault(); zone.classList.remove('over'); const text=e.dataTransfer.getData('text/plain'); if(!text) return; zone.innerHTML=''; const tile=makeTile(text); tile.draggable=true; zone.appendChild(tile); }); }); $('#bank').addEventListener('dragover', e=> e.preventDefault()); $('#bank').addEventListener('drop', e=>{ e.preventDefault(); const text=e.dataTransfer.getData('text/plain'); if(!text) return; const tile=makeTile(text); $('#bank').appendChild(tile); }); }
    async function gradeDragSort(answer){ if(state.submitted) return; const slots=$$('#row .dropzone'); const attempt=slots.map(z=>z.firstChild?z.firstChild.textContent:''); let correct=0; for(let i=0;i<answer.length;i++) if(attempt[i]===answer[i]) correct++; const accuracy=correct/answer.length; const timeMs=Date.now()-state.startTs; const score=Math.round(accuracy*1000 - timeMs/100); $('#feedback').textContent=`Accuracy ${(accuracy*100).toFixed(0)}% • Time ${formatMs(timeMs)} • Score ${score}`; await submitScore(false, score, timeMs, { accuracy, correct }); }
    function renderPostureQuiz(container){ const items=[{q:'Feet flat on the floor',a:true},{q:'Wrists rest heavily on the keyboard',a:false},{q:'Back straight against the chair',a:true},{q:'Eyes very close to the screen',a:false},{q:'F and J fingers on bumps',a:true}]; const wrap=document.createElement('div'); wrap.className='grid gap-2'; items.forEach((it,i)=>{ const row=document.createElement('div'); row.className='flex items-center justify-between gap-2 p-3 rounded-xl border border-slate-200'; row.innerHTML=`<div class="font-medium">${i+1}. ${it.q}</div><div class="flex gap-2"><label class="inline-flex items-center gap-1 text-sm"><input type="radio" name="q${i}" value="true" class="accent-indigo-600"> True</label><label class="inline-flex items-center gap-1 text-sm"><input type="radio" name="q${i}" value="false" class="accent-indigo-600"> False</label></div>`; wrap.appendChild(row); }); container.appendChild(wrap); container.dataset.postureKey=JSON.stringify(items.map(it=>it.a)); }
    async function gradePostureQuiz(){ if(state.submitted) return; const key=JSON.parse($('#challengeArea').dataset.postureKey||'[]'); let correct=0; key.forEach((ans,i)=>{ const picked=document.querySelector(`input[name="q${i}"]:checked`); if(picked && String(ans)===picked.value) correct++; }); const accuracy=correct/key.length; const timeMs=Date.now()-state.startTs; const score=Math.round(accuracy*1000 - timeMs/100); $('#feedback').textContent=`Accuracy ${(accuracy*100).toFixed(0)}% • Time ${formatMs(timeMs)} • Score ${score}`; await submitScore(false, score, timeMs, { accuracy, correct }); }
    async function submitScore(auto=false, score=0, timeMs=0, extra={}){ if(!state.roomCode) return; state.submitted=true; clearInterval(state.timerInterval); const payload={ score, timeMs, submittedAt: firebase.firestore.FieldValue.serverTimestamp(), auto:!!auto, name: state.name }; Object.assign(payload, extra); await db.collection('rooms').doc(state.roomCode).collection('players').doc(state.uid).set(payload, { merge:true }); await renderBoard(); $('#board').classList.remove('hidden'); }
    async function renderBoard(){ if(!state.roomCode) return; const snap=await db.collection('rooms').doc(state.roomCode).collection('players').orderBy('score','desc').orderBy('timeMs','asc').limit(50).get(); const rows=[]; let rank=1; snap.forEach(doc=>{ const p=doc.data(); rows.push(`<tr class="border-b last:border-b-0"><td class="py-2 pr-3">${rank++}</td><td class="py-2 pr-3 font-semibold">${p.name||'Player'}</td><td class="py-2 pr-3">${p.score||0}</td><td class="py-2">${p.timeMs? formatMs(p.timeMs): '—'}</td></tr>`); }); $('#boardTable').innerHTML=`<div class="overflow-x-auto rounded-xl border border-slate-200"><table class="min-w-full text-sm"><thead class="bg-slate-50 text-slate-600"><tr><th class="text-left py-2 pl-3">#</th><th class="text-left py-2">Name</th><th class="text-left py-2">Score</th><th class="text-left py-2">Time</th></tr></thead><tbody class="bg-white">${rows.join('')}</tbody></table></div>`; }

    // ===== Buttons =====
    document.getElementById('makeBtn').addEventListener('click', createRoom);
    document.getElementById('joinBtn').addEventListener('click', joinExisting);
    document.getElementById('copyCodeBtn').addEventListener('click', ()=>{ const v=$('#roomInput').value.trim(); if(!v) return; navigator.clipboard.writeText(v); toast('Copied room code'); });

    // ===== Diagnostics buttons =====
    document.getElementById('diagWrite').addEventListener('click', ()=>{
      if(!db){ logStatus('SDK not ready'); return; }
      db.collection('diag').add({ when:new Date().toISOString(), who:'manual' })
        .then(()=>logStatus('WRITE OK'))
        .catch(e=>logStatus('WRITE ERROR: '+(e?.message||e)));
    });
    document.getElementById('diagRoom').addEventListener('click', async ()=>{
      if(!db){ logStatus('SDK not ready'); return; }
      const code = 'TEST-' + Math.random().toString(36).slice(2,6).toUpperCase();
      try {
        await db.collection('rooms').doc(code).set({
          className: 'Diagnostics', createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          status: 'lobby', currentChallenge: null, endsAt: null
        }, { merge: true });
        await db.collection('rooms').doc(code).collection('players').doc('probe').set({
          name: 'Probe', joinedAt: firebase.firestore.FieldValue.serverTimestamp(), ready:true
        }, { merge: true });
        logStatus('ROOM OK: created '+code+' (check Firestore → rooms)');
        toast('Sample room created: '+code);
      } catch(e){
        logStatus('ROOM WRITE ERROR: '+(e?.message||e));
        toast('Room write failed: '+(e?.message||e), false);
      }
    }); return; } db.collection('diag').add({ when:new Date().toISOString(), who:'manual' }).then(()=>logStatus('WRITE OK')).catch(e=>logStatus('WRITE ERROR: '+(e?.message||e))); });
    document.getElementById('diagClear').addEventListener('click', ()=>{ const p=document.getElementById('diagLog'); if(p) p.textContent=''; const t=document.getElementById('diagText'); if(t) t.textContent='Ready'; });
  </script>

  <!-- Firestore Rules for testing (optional):
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      match /{document=**} { allow read, write: if true; }
    }
  }
  -->
</body>
</html>
